# バス乗務員スケジューリング デモ設計書

単一営業所を対象に、バス乗務員の勤務割を安全かつ公平に作成・検証するための業務支援 Web アプリケーションを定義する。本書はプロダクトのゴール、MVP 要件、将来拡張の設計方針をまとめたものであり、チーム内での共通基準となる。

## 1. プロダクトゴール
- 乗務員シフトを法令順守のもとで迅速に作成し、調整コストを最小化する。
- 配車担当者が運用しやすい UI を備え、違反や公平性の偏りをリアルタイムで可視化する。
- 将来的に数理最適化アルゴリズムと連携し、自動生成結果を安全に受け入れられる基盤を整える。

## 2. 適用範囲と前提
- **対象:** 西鉄をはじめとする国内バス事業者の営業所単位の乗務員計画業務。
- **業務範囲:** シフト編成、乗務員・路線マスタ維持、勤務票のチェック、遵法確認、将来の自動割当結果の受入。
- **非対象（現段階）:** 運賃計算、車両整備計画、運行実績のリアルタイム連携。

## 3. 成功指標（例）
- 法令違反検知の漏れ率 0%。
- シフト調整に要する平均時間を従来比 30% 削減。
- 乗務員あたり残業時間のばらつきを従来比 20% 以内に収束。
- 最適化連携 API の稼働後は、提案割当の受入率 80%以上、再調整時間 50% 削減 を目標。

## 4. 想定ユーザー
- **配車担当者:** 日次・週次でシフトを組む主利用者。ガント操作とリアルタイム違反チェックが必須。
- **運行管理者:** コンプライアンス確認と承認フローを担う。監査ログとダッシュボードを参照。
- **マネジメント層:** 業務負荷や公平性の指標を基に人員計画を調整。

## 5. MVP 要件（インタラクティブ手動編成）
1. **タイムライン UI:** ガントチャートライクな編集画面で、ドラッグ&ドロップ、コピー、Undo/Redo、フィルタ（路線／乗務員／時間帯）を提供。
2. **リアルタイム遵法チェック:** 道路運送法・労働基準法・国交省ガイドラインをルールエンジン化し、違反度合いに応じた色分け表示（赤=重大、橙=注意）。違反理由と改善ヒントを提示。
3. **勤務パターンのテンプレ化:** 交番（行路パターン）をテンプレートとして保存し、営業所固有のルールに合わせて再利用。
4. **ダッシュボード:** 日/週単位の残業時間、拘束時間、休憩取得状況、公平性スコアを可視化。 escenario（案）ごとの比較表示をサポート。
5. **データ管理モーダル:** 乗務員・路線・休暇・車両の各マスタをモーダルで更新し、変更は監査ログに記録。
6. **監査ログ出力:** 操作履歴と違反検出履歴を CSV/PDF でエクスポート可能。


## 6. MVP データ要件と業務前提
### 6.1 入力データセット
- **路線・時刻表データ:** GTFS などの標準形式または営業所内の時刻表 Excel から、路線 ID・便 ID・発着時刻・運行曜日・運行距離・折返し地点を取り込み、行路編集の基礎とする。Optibus 事例のようにダイヤ→車両→乗務員を一気通貫で扱える粒度（Trip/Block/Run）まで情報を整備する。
- **車両運用・行路テンプレート:** 日別の仕業ブロック、車両の連続運用（ブロッキング）情報、交番ローテーションの原型。既存行路表をテンプレ化し、編集画面でのドラッグ操作に即応できる形で保持する。
- **乗務員マスタ:** 氏名・所属・保有免許（大型二種等）・担当可能路線・乗務可能車種・勤務希望・勤続年数。Optibus/Optium で実装されているように、連続運転上限や休憩取得履歴など個別制約を紐づける。
- **制約・ルールマスタ:** 改善基準告示の拘束時間・休息インターバル（例: 日勤間9時間以上）、週平均労働時間、分割勤務（スプレッド）上限、残業上限、労使協定で定める特例など。違反時にリアルタイム警告へ反映できる粒度で保持する。
- **勤怠・休暇・資格実績:** 出退勤・残業・有休・点呼結果・健康チェック・最新の資格更新情報。名鉄バス×Optium のように勤怠システムと相互連携し、翌日の計画に反映することを想定。
- **評価指標定義:** 残業時間、拘束時間、休憩取得率、公平性スコア（シフト巡回、希望充足度等）、コスト指標。シナリオ比較やダッシュボード表示のために算出方法と閾値を事前に合意する。

### 6.2 遵法計算・可視化の前提
- 改善基準告示・労基法・社内就業規則の条文を ID 付きメタデータ化し、違反アラートには条文と修正ヒントを併記する。Optibus 同様、修正しない限り確定できないガードも検討。
- 週次ロスター編成では回り番・連続勤務日数・連休パターンを自動検証し、極端な残業や休憩不足が特定乗務員に偏らないよう公平性メトリクスを算出。
- ダッシュボードは日/週単位の KPI を即時計算し、違反リスト・残業ヒートマップ・人員不足アラートを色分け表示する。
- リアルタイム再計算を前提に、UI 上の編集操作ごとに制約再評価を行う（Optibus が提供する即時計測と同等の応答）。

### 6.3 運用・連携前提

### 6.4 GTFS 取込から手動割当までの標準フロー
1. **GTFS ZIP 取込:** gtfs.zip（gency.txt, 
outes.txt, 	rips.txt, stop_times.txt, calendar.txt など）をアップロードし、路線・系統・便のマスタを生成する。JSZip / PapaParse を用いてブラウザ内で解凍・CSV 解析を行い、営業所固有の便名や系統コードがある場合はインポート前にマッピングテーブルで補正する。
2. **ダイヤ整形・検証:** GTFS の 	rip_id/lock_id を基に車両ブロックを自動構成し、運行距離・所要時間・折返し時間を算出。欠損・重複・走行不可区間（例: 折返し時間不足）を自動検知して修正。
3. **手動行路・交番割当:** タイムライン UI 上で車両ブロックを乗務員にドラッグ割当し、交番テンプレートへ配置。割当ごとに拘束時間・休息・資格要件をリアルタイム検証する。
4. **遵法・効率チェック:** ダッシュボードで残業時間・拘束時間・休憩取得率・公平性メトリクスを確認し、違反が残っていれば再調整。
5. **シナリオ保存・エクスポート:** 調整後の行路/交番をシナリオとして保存し、勤怠・運用システム向けに CSV/GTFS などで出力。必要に応じて次フェーズの最適化サービスへ API 送信できるようインターフェースを統一する。

### 6.5 プロジェクト構成
`
saitekika-demo/
├── docs/                     # 競合・調査ドキュメント
├── src/
│   ├── components/           # UI コンポーネントとモーダル群
│   │   └── icons/            # アイコンコンポーネント
│   ├── services/             # モック/データ取込/保存などのサービス
│   │   └── gtfs/             # GTFS 解析ユーティリティ
│   ├── types/                # ドメイン型定義 (index.ts)
│   ├── App.tsx               # 画面レイアウト/ビュー切替
│   └── main.tsx              # React エントリポイント
├── index.html                # Vite エントリ (script: /src/main.tsx)
├── metadata.json             # 製品メタ情報
├── package.json              # 依存関係とスクリプト
├── tsconfig.json             # TypeScript 設定
├── vite.config.ts            # Vite 設定 (alias '@' -> src)
└── README.md                 # 本設計書
`





### 6.6 サンプル GTFS (群馬中央バス) の構成確認
- データファイル: `data/GTFS-JP(gunmachuo).zip`
- 主なテーブルとカラム
  - `routes.txt`: route_id, route_short_name, route_long_name, route_type など
  - `trips.txt`: trip_id, route_id, service_id, block_id, shape_id, direction_id など
  - `stop_times.txt`: trip_id, arrival_time, departure_time, stop_id, stop_sequence など
  - `stops.txt`: stop_id, stop_name, stop_lat, stop_lon, zone_id など
  - `calendar.txt` / `calendar_dates.txt`: service_id と運行可否日の定義
  - `shapes.txt`: shape_id と経路座標
  - `fare_attributes.txt` / `fare_rules.txt`: 運賃体系（MVP では後続対応）
  - `translations.txt`, `feed_info.txt`: 表示翻訳とフィードメタ情報
- インポーター現在値: `routes.txt`, `trips.txt`, `stop_times.txt`, `calendar.txt` を必須として解析。`stops`, `shapes`, `calendar_dates`, `fare_*` は後続で取り込み予定。
- ドメインマッピング: `services/gtfs/mappers.ts` で TripSummary / RouteSummary / ServiceCalendarSummary / StopLookup を生成し、UI やスケジュール作成のベースデータとして活用できる状態に整備。
## 7. 実行・デプロイ前提
- **動作形態:** MVP はローカル開発用の Vite + Node.js サーバーで稼働しつつ、同一コードベースをそのままクラウド/オンプレの静的ホスティングやエッジ環境へデプロイできる構成とする。ビルド成果物は CDN 配信可能な静的アセットとし、API 呼び出しを行うサービス層は環境変数でエンドポイントを切り替える。
- **ローカルサーバー起動:** `npm run dev -- --port 3000` を推奨手順とし、ブラウザからは `http://localhost:3000/` を基準 URL としてアクセスする（5173 が使用中の場合もポート指定で安定稼働）。
  - Vite 6 はプロジェクトパスに `#` など URL 解釈対象の文字が含まれるとモジュール解決に失敗するため、開発作業時は `C:/Projects/saitekika-demo` などシンプルなパスへコピーして作業し、ビルド成果物のみ必要に応じて OneDrive へ反映する。
- **データ永続化:** 専用 DB を持たず、GTFS/CSV インポート後の編集結果を JSON などのローカルファイルとして保存・再読み込みできる機能を提供。保存時には行路・交番・制約設定・シナリオ比較結果をまとめたプロジェクトファイル（例: schedule_project.json）を生成し、手動/自動バックアップをサポート。
- **マルチ環境:** ローカルでのオフライン運用を想定しつつ、必要に応じてファイルストレージ（OneDrive, SharePoint 等）と同期して複数担当者で共有可能にする。将来 DB を導入する場合も、既存のファイル形式をインポートするアダプタを用意し移行コストを最小化する。
- **セキュリティ:** 保存ファイルは AES 等で暗号化するオプションを設け、乗務員個人情報を保護。クラウドデプロイ時は API キーやアクセストークンを .env / セキュアストアで管理する。


## 7. 将来拡張（フェーズ2 以降）
- **最適化アルゴリズム連携:** Python 製の最適化サービスを別コンポーネントとして用意し、REST API でデータ受渡し。`services/optimizationAdapter.ts`（仮称）で入出力フォーマットを規定。
- **自動提案のシミュレーション表示:** アルゴリズムから返却された案を比較テーブルと差分ハイライトで提示し、全体採用・部分採用・却下を選択可能にする。
- **シナリオ比較管理:** スナップショット保存、KPI 比較、承認ワークフローとの連携。
- **多営業所展開:** データモデルをマルチデポ対応に拡張し、横断的な人員配分や応援計画を考慮。

## 8. 機能アーキテクチャ
- **フロントエンド:** React 19 + TypeScript + Vite。Tailwind 風ユーティリティクラスで UI 構築。
- **状態管理:** React Hooks（`useState` / `useMemo` / `useCallback`）を基本とし、将来的に複雑化する場合は Zustand など軽量ストアを検討。
- **サービス層:** 現状は `services/mockScheduleService.ts` によるモック生成と、`services/gtfs/importGtfsZip.ts`・`services/projectStorage.ts` によるデータ取込/保存基盤を提供。将来は `services/complianceEngine.ts`、`services/optimizationAdapter.ts` を実装してルール判定・最適化 API 呼び出しを分離。
- **データモデル:** `types.ts` に乗務員、路線、制約、シフト、シナリオ、メトリクスを定義。違反判定結果（種別、根拠条文、重大度）を保持できる構造に拡張。
- **監査・ロギング:** 重要操作はクライアント側でイベント化し、バックエンド実装後は永続化を想定。

## 9. コンプライアンスと安全運用
- 法令根拠をメタデータ化し、違反検知時に条文・社内規程番号を併記。
- 点呼・健康状態チェック・乗務員資格（大型二種、特定旅客など）の管理項目を UI 上で追跡可能にする。
- 個人情報保護: 氏名・免許情報は役割に応じてマスキング。エクスポート時はアクセス権チェックを行う。

## 10. UI/UX ガイドライン
- 色覚多様性に配慮したカラーパレット。重大違反は赤、軽微はアンバー、適合はグリーン。
- キーボードショートカット（コピー/貼付、日付移動、乗務員検索）を設計し、慣れた担当者の速度を阻害しない。
- モバイルビューは業務監視用ダッシュボードに限定し、編集はデスクトップ最適化。
- Undo/Redo と変更履歴を常に利用可能にし、誤操作リスクを低減。

## 11. 競合ベンチマークからの示唆
- **Optibus:** 大規模事業者の導入実績。リアルタイム遵法チェック、手動調整と自動提案のシームレス統合、シナリオ比較を重視。
- **ALGO ARTIS (Optium):** 国内での交番作成効率化に特化。最適化アルゴリズムと UI を密結合し、交番作成時間/人員調整時間の大幅削減を実現。
- **示唆:** MVP 段階から「違反検知」「公平性」「シナリオ比較」を UI 体験として盛り込み、後段でアルゴリズムを API 連携する設計が優れている。監査対応やテンプレ化による再利用性も早期に組み込む。

## 12. オープン課題と次ステップ
- 西鉄対象営業所の実路線データ・勤務実績の収集と、モデルへのマッピング。
- コンプライアンスルールの正式な条文整理とルールエンジン仕様策定。
- UI プロトタイピング（ガント編集、違反アラート、ダッシュボード）と現場ヒアリング。
- Python 最適化サービスに渡すデータスキーマ（JSON）とレスポンス仕様のドラフト作成。

## 13. MVP 実装 TODO (工程表)
- [x] コードベースを src/ 配下に再配置し、不要ファイル・未使用依存を削除してビルド設定を整理する。
- [x] GTFS ZIP 取込ユーティリティを実装し、calendar/trips/stop_times から便・ブロック情報を生成する。
- [x] GTFS から得た車両ブロックをアプリ内ドメイン（Route/Shift/Scenario）へマッピングし、欠損・重複チェックを自動化する。
- [x] GTFS stops/shapes/calendar_dates/fare 情報の解析とドメインモデルへのマッピングを追加し、地理情報・臨時便の取り扱いを定義する。
- [ ] スケジュール状態管理（シナリオ保存、Undo/Redo、差分比較）を実装し、UI から操作できるようにする。
- [ ] タイムライン UI にドラッグ&ドロップ／キーボード操作／フィルタリングを実装し、手動行路・交番割当を可能にする。
- [ ] 遵法判定エンジンを構築し、拘束時間・休息・資格要件のリアルタイム検証とアラート表示を行う。
- [ ] ダッシュボードで残業時間・拘束時間・公平性スコアなど KPI を集計し、シナリオ比較ビューを実装する。
- [ ] プロジェクトファイル (schedule_project.json) の保存／読込、およびバージョン履歴管理（自動バックアップ）を実装する。
- [ ] E2E テスト・主要ユニットテストを追加し、GTFS 取込〜手動割当〜保存までの回帰チェックを自動化する。
- [ ] Vite ビルド成果物の出力確認と静的ホスティング（例: Vercel/S3）向けデプロイ手順書を整備する。

---
本ドキュメントは、運行計画・労務遵法に精通した専門家の知見を踏まえて編纂したものであり、MVP 実装および将来の最適化連携を判断する際の基準とする。





## 6.7 ローカルサーバー起動メモ
- `#` を含むディレクトリで Vite 6 を動かすと `Failed to load url /src/main.tsx` などの解決エラーが出るため、開発時は `C:/Projects/saitekika-demo` のような `#` や全角を含まないパスへコピーして作業する。
- 旧バージョンでは既定ポート 5173 を使用するが、この環境では `http://localhost:5173/` が 404 になったため、`npm run dev -- --port 3000` を標準起動手順とし、ブラウザも `http://localhost:3000/` で確認する。
- 起動コマンドを実行したターミナルは閉じずに開きっぱなしにしておく（`Ctrl+C` で停止するとブラウザは即 404 になる）。
## 14. GitHub Pages デプロイ
- リモートリポジトリ: `git@github.com:ZephyrCivic/driveroptimaization.git`（デフォルトブランチは `master`）。
- `master` ブランチへ push すると、`/.github/workflows/deploy.yml` が起動し、自動で `npm ci` → `npm run build` → GitHub Pages へのデプロイを行う。
- 公開 URL: https://zephyrcivic.github.io/driveroptimaization/
- 初回のみ GitHub リポジトリの Settings → Pages で「GitHub Actions」を選択し、ワークフローを許可する。
- ローカルで `npm run build` を実行する場合は、`#` や全角文字を含まないパス（例: `C:/Projects/saitekika-demo`）へ一時的にコピーしてビルドする。
